<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout - Artigianato Online</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/favicon.png">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Assicurati che il percorso a style.css sia corretto -->
    <link type="text/css" rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        const urlBaseApi = "";
        const tipoStorage = localStorage;
        const chiaveCarrello = 'cart';
        const chiaveDatiUtente = 'userData';
        const chiaveToken = 'sessionToken';

        let datiCarrello = {};
        let datiUtente = null;
        let tokenAuth = null;

        try {
            datiCarrello = JSON.parse(tipoStorage.getItem(chiaveCarrello) || '{}');
        } catch (e) {
            console.error("Errore nel parsing del carrello:", e);
            tipoStorage.removeItem(chiaveCarrello);
        }
        try {
            datiUtente = JSON.parse(localStorage.getItem(chiaveDatiUtente) || 'null');
            tokenAuth = localStorage.getItem(chiaveToken);
        } catch (e) {
            console.error("Errore nel parsing dei dati utente:", e);
            localStorage.removeItem(chiaveDatiUtente);
            localStorage.removeItem(chiaveToken);
        }
        $(document).ready(function () {

            const riepilogoArticoliCarrello = $('#cart-summary-items');
            const elementoSubtotale = $('#subtotal');
            const elementoCostoSpedizione = $('#shipping-cost');
            const elementoPrezzoTotale = $('#total-price');
            const inputOpzioniSpedizione = $('#shipping-options input[name="shippingMethod"]');
            const modulo = $('#checkout-form');
            const pulsanteCompletaOrdine = $('#complete-order-btn');
            const segnapostoAlert = $('#alert-placeholder');
            const minimoSpedizioneGratuita = 100;

            let subtotaleCorrente = 0;
            let costoSpedizioneCorrente = 0;

            function popolaRiepilogoCarrello() {
                riepilogoArticoliCarrello.empty();
                subtotaleCorrente = 0;
                const articoli = Object.values(datiCarrello);

                if (articoli.length === 0) {
                    riepilogoArticoliCarrello.html('<p class="text-center text-muted">Il tuo carrello è vuoto.</p>');
                    pulsanteCompletaOrdine.prop('disabled', true).text('Carrello Vuoto');
                    disabilitaCampiForm(true);
                    pulsanteCompletaOrdine.prop('disabled', true).text('Carrello Vuoto');
                    return;
                }

                const listaArticoli = $('<ul class="list-unstyled"></ul>');
                articoli.forEach(articolo => {
                    const prezzo = parseFloat(articolo.price);
                    const quantita = parseInt(articolo.quantity, 10);

                    if (!isNaN(prezzo) && !isNaN(quantita) && quantita > 0) {
                        const totaleArticolo = prezzo * quantita;
                        subtotaleCorrente += totaleArticolo;
                        const elementoLista = $(`
                            <li class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center">
                                    <img src="${articolo.image_url}" alt="${articolo.name || 'Prodotto'}" class="immagine-prodotto-carrello me-2" onerror="this.onerror=null;this.src='images/favicon.png';">
                                    <div>
                                        <p class="small mb-0">${articolo.name || 'Nome Prodotto Mancante'}</p>
                                        <p class="text-muted mb-0 small">${articolo.artisan_shop_name || 'Negozio Sconosciuto'}</p>
                                        <p class="text-muted small mb-0">Quantità: ${quantita}</p>
                                    </div>
                                </div>
                                <small>${formattaPrezzo(totaleArticolo)}</small>
                            </li>
                        `);
                        listaArticoli.append(elementoLista);
                    } else {
                        console.warn("Articolo nel carrello con dati non validi:", articolo);
                        const elementoErrore = $(`<li class="text-danger small mb-2">Errore: Articolo non valido nel carrello (ID: ${articolo.id || 'NA'})</li>`);
                        listaArticoli.append(elementoErrore);
                    }
                });
                riepilogoArticoliCarrello.append(listaArticoli);
                disabilitaCampiForm(false);
                aggiornaTotale();
            }

            /**
             * Popola i dati dell'utente nel modulo se loggato
             */
            function popolaDatiUtente() {
                if (datiUtente) {
                    const partiNome = datiUtente.full_name ? datiUtente.full_name.split(' ') : ['', ''];
                    $('#first-name').val(partiNome[0] || '');
                    $('#last-name').val(partiNome.slice(1).join(' ') || '');
                    $('#email').val(datiUtente.email || '');
                    $('#phone').val(datiUtente.phone_number || '');
                    if (datiUtente.address) {
                        $('#address').val(datiUtente.address);
                    }
                    $('#bank-customer-name').text(datiUtente.full_name || '[Nome Cognome]');
                } else {
                    $('#bank-customer-name').text('[Nome Cognome]');
                    //Aggiunti parametri URL per specificare quale tab aprire
                    mostraAlert('Sembra che tu non sia loggato. Per procedere, <a href="auth/autenticazione.html?tab=login">accedi</a> o <a href="auth/autenticazione.html?tab=register">registrati</a>.', 'info');
                    disabilitaCampiForm(true);
                    pulsanteCompletaOrdine.prop('disabled', true).text('Accedi per continuare');
                }
            }

            /**
             * Aggiorna il totale dell'ordine e la gestione spedizione gratuita
             */
            function aggiornaTotale() {
                const eleggibileSpedizioneGratuita = subtotaleCorrente >= minimoSpedizioneGratuita;
                const contenitoreSpedizioneGratuita = $('.free-shipping-option');
                const radioSpedizioneGratuita = $('#shipping-free');

                if (eleggibileSpedizioneGratuita) {
                    contenitoreSpedizioneGratuita.show();
                    const attualmenteSelezionato = inputOpzioniSpedizione.filter(':checked');
                    if (attualmenteSelezionato.attr('id') !== 'shipping-express') {
                        if (!radioSpedizioneGratuita.is(':checked')) {
                            radioSpedizioneGratuita.prop('checked', true);
                            inputOpzioniSpedizione.not(radioSpedizioneGratuita).prop('checked', false);
                        }
                    }

                } else {
                    if (radioSpedizioneGratuita.is(':checked')) {
                        $('#shipping-standard').prop('checked', true);
                    }
                    contenitoreSpedizioneGratuita.hide();
                    radioSpedizioneGratuita.prop('checked', false);
                }

                const spedizioneSelezionata = inputOpzioniSpedizione.filter(':checked');
                costoSpedizioneCorrente = parseFloat(spedizioneSelezionata.data('cost') || 0);

                elementoSubtotale.text(formattaPrezzo(subtotaleCorrente));
                elementoCostoSpedizione.text(formattaPrezzo(costoSpedizioneCorrente));
                elementoPrezzoTotale.text(formattaPrezzo(subtotaleCorrente + costoSpedizioneCorrente));
            }

            inputOpzioniSpedizione.on('change', function () {
                aggiornaTotale();
            });

            modulo.on('submit', async function (event) {
                event.preventDefault();
                segnapostoAlert.empty();

                if (!tokenAuth) {
                    mostraAlert('Devi essere loggato per completare l\'ordine. <a href="/login.html">Accedi</a>', 'warning');
                    pulsanteCompletaOrdine.prop('disabled', true);
                    return;
                }

                if (Object.keys(datiCarrello).length === 0) {
                    mostraAlert('Il tuo carrello è vuoto.', 'warning');
                    pulsanteCompletaOrdine.prop('disabled', true).text('Carrello Vuoto');
                    return;
                }
                if (!this.checkValidity()) {
                    event.stopPropagation();
                    $(this).addClass('was-validated');
                    mostraAlert("Per favore, compila tutti i campi necessari evidenziati in rosso.", "warning");
                    const primoElementoInvalido = $(this).find(':invalid').first();
                    if (primoElementoInvalido.length) {
                        primoElementoInvalido[0].scrollIntoView({behavior: 'smooth', block: 'center'});
                        primoElementoInvalido.focus();
                    }
                    return;
                }

                const metodoPagamento = $('#payment-tabs .nav-link.active').data('payment-method') || 'credit_card';
                if (metodoPagamento !== 'bank_transfer' && !validaDatiPagamento(metodoPagamento)) {
                    const messaggioMetodo = metodoPagamento === 'credit_card' ? 'carta di credito' : (metodoPagamento === 'paypal' ? 'PayPal (solo email richiesta)' : 'pagamento selezionato');
                    mostraAlert(`Per favore, inserisci tutti i dati richiesti per il pagamento con ${messaggioMetodo}.`, "warning");
                    $('#payment-tabs')[0].scrollIntoView({behavior: 'smooth', block: 'center'});
                    return;
                }

                $(this).addClass('was-validated');

                pulsanteCompletaOrdine.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Elaborazione...');

                const articoliCarrello = Object.values(datiCarrello).map(articolo => ({
                    product_id: articolo.id,
                    quantity: articolo.quantity
                }));
                const indirizzoSpedizione = $('#address').val().trim();
                const spedizioneSelezionata = inputOpzioniSpedizione.filter(':checked');
                const valoreMetodoSpedizione = spedizioneSelezionata.val();
                const note = $('#notes').val().trim();

                const datiOrdine = {
                    customer_id: datiUtente.user_id,
                    items: articoliCarrello,
                    shipping_address: indirizzoSpedizione,
                    billing_address: indirizzoSpedizione,
                    shipping_method: valoreMetodoSpedizione,
                    notes: note || null,
                    total_amount: subtotaleCorrente + costoSpedizioneCorrente
                };

                let datiOrdineCreato = null;
                try {
                    console.log("Invio Payload Ordine:", JSON.stringify(datiOrdine, null, 2));
                    const rispostaOrdine = await fetch(`${urlBaseApi}/api/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tokenAuth}`
                        },
                        body: JSON.stringify(datiOrdine)
                    });

                    if (!rispostaOrdine.ok) {
                        let messaggioErrore = `Errore ${rispostaOrdine.status}: ${rispostaOrdine.statusText}`;
                        try {
                            const datiErrore = await rispostaOrdine.json();
                            messaggioErrore = `Errore creazione ordine: ${datiErrore.message || messaggioErrore}`;
                        } catch (e) {
                        }
                        throw new Error(messaggioErrore);
                    }

                    datiOrdineCreato = await rispostaOrdine.json();
                    console.log("Risposta Ordine:", datiOrdineCreato);
                    $('#bank-order-ref').text(datiOrdineCreato.order_id || '[N/A]');

                } catch (error) {
                    console.error("Errore API Ordine:", error);
                    mostraAlert(`Errore durante la creazione dell'ordine: ${error.message || 'Si è verificato un problema.'}`, "danger");
                    pulsanteCompletaOrdine.prop('disabled', false).text('Completa Ordine');
                    return;
                }
                const importoTotale = subtotaleCorrente + costoSpedizioneCorrente;

                let resultSimulazione = null;
                if (metodoPagamento !== 'bank_transfer') {
                    try {
                        console.log(`Elaborazione pagamento ${metodoPagamento} per importo €${importoTotale}...`);
                        pulsanteCompletaOrdine.text('Elaborazione pagamento...');

                        resultSimulazione = await simulaElaborazionePagamento(metodoPagamento, importoTotale);
                        console.log('Completato:', resultSimulazione);

                    } catch (errorePagamento) {
                        console.error("Errore pagamento:", errorePagamento);
                        mostraAlert(`Pagamento non riuscito: ${errorePagamento.message}. Riprova con un altro metodo di pagamento.`, "danger");
                        pulsanteCompletaOrdine.prop('disabled', false).text('Riprova Pagamento');
                        return;
                    }
                }

                const datiPagamento = {
                    order_id: datiOrdineCreato.order_id,
                    amount: importoTotale,
                    payment_method: metodoPagamento,
                    status: (metodoPagamento === 'bank_transfer') ? 'pending' : 'completed',
                    payment_date: new Date().toISOString(),
                    ...(resultSimulazione?.transactionId && {transaction_id: resultSimulazione.transactionId})
                };

                try {
                    console.log("Invio Payload Pagamento:", JSON.stringify(datiPagamento, null, 2));
                    const rispostaPagamento = await fetch(`${urlBaseApi}/api/payments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tokenAuth}`
                        },
                        body: JSON.stringify(datiPagamento)
                    });

                    if (!rispostaPagamento.ok) {
                        let messaggioErrore = `Errore ${rispostaPagamento.status}: ${rispostaPagamento.statusText}`;
                        try {
                            const datiErrore = await rispostaPagamento.json();
                            messaggioErrore = `Errore registrazione pagamento: ${datiErrore.message || messaggioErrore}`;
                        } catch (e) {
                        }
                        mostraAlert(`L'ordine #${datiOrdineCreato.order_id} è stato creato, ma si è verificato un errore durante la registrazione del pagamento: ${messaggioErrore}. Contatta l'assistenza o riprova.`, "warning");
                        pulsanteCompletaOrdine.prop('disabled', false).text('Riprova Pagamento?');
                        return;
                    }
                    const esitoPagamento = await rispostaPagamento.json();
                    console.log("Risposta Pagamento:", esitoPagamento);

                    tipoStorage.removeItem(chiaveCarrello);
                    datiCarrello = {};

                    mostraAlert(`Ordine #${datiOrdineCreato.order_id} completato con successo! Riceverai una conferma via email.`, 'success');
                    pulsanteCompletaOrdine.removeClass('btn-primary').addClass('btn-success').text('Ordine Completato');

                } catch (error) {
                    console.error("Errore API Pagamento:", error);
                    mostraAlert(`Ordine #${datiOrdineCreato.order_id} creato, ma errore imprevisto durante il pagamento: ${error.message || 'Problema di comunicazione.'}. Contatta l'assistenza.`, "warning");
                    pulsanteCompletaOrdine.prop('disabled', false).text('Riprova Pagamento?');
                    return;
                }
            });
            $('#payment-tabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (event) {
                resetValidazionePagamento();
            });

            $('#card-number').on('input', function () {
                let valore = $(this).val().replace(/\s/g, '').replace(/[^0-9]/g, '');
                let valoreFormattato = valore.match(/.{1,4}/g)?.join(' ') || valore;
                if (valoreFormattato.length > 19) valoreFormattato = valoreFormattato.substring(0, 19);
                $(this).val(valoreFormattato);

                const numeroSenzaSpazi = valore;
                if (numeroSenzaSpazi.length === 16) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (numeroSenzaSpazi.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#card-expiry').on('input', function () {
                let valore = $(this).val().replace(/[^0-9]/g, '');
                if (valore.length >= 2) {
                    valore = valore.substring(0, 2) + '/' + valore.substring(2, 4);
                }
                $(this).val(valore);

                if (valore.length === 5) {
                    const [mese, anno] = valore.split('/');
                    const meseNum = parseInt(mese);
                    const annoNum = parseInt(anno);
                    const annoCorrente = new Date().getFullYear() % 100;
                    const meseCorrente = new Date().getMonth() + 1;

                    if (meseNum >= 1 && meseNum <= 12 && annoNum >= annoCorrente &&
                        !(annoNum === annoCorrente && meseNum < meseCorrente)) {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#card-cvv').on('input', function () {
                let valore = $(this).val().replace(/[^0-9]/g, '');
                if (valore.length > 4) valore = valore.substring(0, 4);
                $(this).val(valore);

                if (valore.length >= 3) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#card-name').on('input', function () {
                const valore = $(this).val().trim();
                if (valore.length >= 3 && valore.includes(' ')) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });
            $('#paypal-email').on('input', function () {
                const valore = $(this).val().trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(valore)) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            popolaRiepilogoCarrello();
            popolaDatiUtente();
        });

        /**
         * Disabilita/Riabilita campi form (tranne riepilogo)
         * @param {boolean} disable - Se true disabilita i campi, se false li riabilita
         */
        function disabilitaCampiForm(disable) {
            $('#checkout-form .card:not(:last-of-type) :input').prop('disabled', disable);
        }

        /**
         * Resetta la validazione dei campi di pagamento
         */
        function resetValidazionePagamento() {
            $('#payment-tabs-content .form-control').removeClass('is-valid is-invalid');
        }

        /**
         * Valida i dati di pagamento in base al metodo selezionato
         * @param {string} metodoPagamento - Il metodo di pagamento selezionato
         * @returns {boolean} - True se la validazione è passata
         */
        function validaDatiPagamento(metodoPagamento) {
            let valido = true;

            if (metodoPagamento === 'credit_card') {
                const numeroCartaElement = $('#card-number');
                const nomeCartaElement = $('#card-name');
                const scadenzaElement = $('#card-expiry');
                const cvvElement = $('#card-cvv');

                const numeroCarta = numeroCartaElement.val().replace(/\s/g, '');
                const nomeCarta = nomeCartaElement.val().trim();
                const scadenza = scadenzaElement.val();
                const cvv = cvvElement.val();

                if (numeroCarta.length !== 16 || !/^\d{16}$/.test(numeroCarta)) {
                    numeroCartaElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    numeroCartaElement.addClass('is-valid').removeClass('is-invalid');
                }

                if (nomeCarta.length < 3 || !nomeCarta.includes(' ')) {
                    nomeCartaElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    nomeCartaElement.addClass('is-valid').removeClass('is-invalid');
                }

                if (scadenza.length !== 5 || !/^\d{2}\/\d{2}$/.test(scadenza)) {
                    scadenzaElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    const [mese, anno] = scadenza.split('/');
                    const meseNum = parseInt(mese);
                    const annoNum = parseInt(anno);
                    const annoCorrente = new Date().getFullYear() % 100;
                    const meseCorrente = new Date().getMonth() + 1;

                    if (meseNum < 1 || meseNum > 12 || annoNum < annoCorrente ||
                        (annoNum === annoCorrente && meseNum < meseCorrente)) {
                        scadenzaElement.addClass('is-invalid').removeClass('is-valid');
                        valido = false;
                    } else {
                        scadenzaElement.addClass('is-valid').removeClass('is-invalid');
                    }
                }

                if (cvv.length < 3 || cvv.length > 4 || !/^\d{3,4}$/.test(cvv)) {
                    cvvElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    cvvElement.addClass('is-valid').removeClass('is-invalid');
                }
            } else if (metodoPagamento === 'paypal') {
                const emailElement = $('#paypal-email');

                const email = emailElement.val().trim();

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    emailElement.addClass('is-valid').removeClass('is-invalid');
                }
            }

            return valido;
        }

        /**
         * Simula l'elaborazione del pagamento e genera un transaction_id
         * @param {string} metodoPagamento - Il metodo di pagamento
         * @param {number} importo - L'importo del pagamento
         * @returns {Promise} - Promise che risolve con i dati del pagamento simulato
         */
        async function simulaElaborazionePagamento(metodoPagamento, importo) {
            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));

            const successo = Math.random() > 0.05;

            if (!successo) {
                const errori = [
                    'Carta di credito rifiutata',
                    'Fondi insufficienti',
                    'Carta scaduta',
                    'Credenziali PayPal non valide',
                    'Servizio temporaneamente non disponibile'
                ];
                const erroreSimulato = errori[Math.floor(Math.random() * errori.length)];
                throw new Error(erroreSimulato);
            }

            let transactionId;
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 10).toUpperCase();

            switch (metodoPagamento) {
                case 'credit_card':
                    transactionId = `CC_${timestamp}_${random}`;
                    break;
                case 'paypal':
                    transactionId = `PAYPAL_${timestamp}_${random}`;
                    break;
                case 'bank_transfer':
                    transactionId = `BANK_${timestamp}_${random}`;
                    break;
                default:
                    transactionId = `TXN_${timestamp}_${random}`;
            }

            return {
                transactionId: transactionId,
                status: 'completed',
                paymentDate: new Date().toISOString(),
                amount: importo,
                method: metodoPagamento
            };
        }

        /**
         * Formatta un prezzo in formato euro
         * @param {number} prezzo - Il prezzo da formattare
         * @returns {string} Il prezzo formattato (es. "€12,50")
         */
        function formattaPrezzo(prezzo) {
            if (typeof prezzo !== 'number' || isNaN(prezzo)) {
                console.warn("Tentativo di formattare un prezzo non valido:", prezzo);
                return '€--.--';
            }
            return `€${prezzo.toFixed(2).replace('.', ',')}`;
        }

        /**
         * Gestisce la visualizzazione di alert Bootstrap
         * @param {string} messaggio - Il messaggio da mostrare
         * @param {string} tipo - Il tipo di alert ('success', 'danger', 'warning', 'info')
         */
        function mostraAlert(messaggio, tipo = 'success') {
            const contenitore = document.createElement('div');
            const alertPlaceholder = $('#alert-placeholder');
            contenitore.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                   ${messaggio}
                   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            alertPlaceholder.html(contenitore);
        }

    </script>
</head>
<body>

<div class="container py-5">
    <div class="row mb-3">
        <div class="col">
            <a href="carrello.html" class="link-dark text-decoration-none"><p class="small"><i
                    class="bi bi-arrow-left"></i> Torna al carrello</p></a>
        </div>
    </div>

    <h1 class="mb-5 fw-bold">Checkout</h1>

    <div id="alert-placeholder" class="mb-4"></div>

    <form id="checkout-form" novalidate>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="d-flex flex-column gap-4">

                    <div class="card p-2">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="bi bi-truck me-2"></i>Informazioni di spedizione
                            </h5>
                            <small class="text-muted">Inserisci i dettagli per la consegna del tuo ordine</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="first-name" class="form-label small fw-semibold">Nome</label>
                                    <input type="text" class="form-control" id="first-name"
                                           placeholder="Il tuo nome" required>
                                    <div class="invalid-feedback">
                                        Il nome è obbligatorio.
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="last-name" class="form-label small fw-semibold">Cognome</label>
                                    <input type="text" class="form-control" id="last-name"
                                           placeholder="Il tuo cognome" required>
                                    <div class="invalid-feedback">
                                        Il cognome è obbligatorio.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="email" class="form-label small fw-semibold">Email</label>
                                    <input type="email" class="form-control" id="email" placeholder="nome@esempio.com"
                                           required>
                                    <div class="invalid-feedback">
                                        Inserisci un indirizzo email valido.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="phone" class="form-label small fw-semibold">Telefono <span
                                            class="text-muted fw-normal">(Opzionale)</span></label>
                                    <input type="tel" class="form-control" id="phone" placeholder="+39 123 456 7890">
                                </div>
                                <div class="col-12">
                                    <label for="address" class="form-label small fw-semibold">Indirizzo completo</label>
                                    <textarea class="form-control" id="address" rows="3" placeholder="Es: Mario Rossi
Via Roma, 123
20100 Milano MI
Italia" required></textarea>
                                    <div class="form-text small mt-1">Inserisci nome/cognome (se diverso), via, numero
                                        civico, CAP, città, provincia e paese.
                                    </div>
                                    <div class="invalid-feedback">
                                        L'indirizzo di spedizione è obbligatorio.
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="notes" class="form-label small fw-semibold">Note per la consegna <span
                                            class="text-muted fw-normal">(Opzionale)</span></label>
                                    <textarea class="form-control" id="notes" rows="2"
                                              placeholder="Istruzioni speciali per il corriere..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metodo di Pagamento -->
                    <div class="card p-2">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="bi bi-credit-card me-2"></i>Metodo di pagamento
                            </h5>
                            <small class="text-muted">Scegli come vuoi pagare il tuo ordine</small>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs nav-fill mb-3" id="payment-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link text-dark active" id="card-tab-btn" data-bs-toggle="tab"
                                            data-bs-target="#card-tab-pane" type="button" role="tab"
                                            aria-controls="card-tab-pane" aria-selected="true"
                                            data-payment-method="credit_card">Carta di credito
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link text-dark" id="paypal-tab-btn" data-bs-toggle="tab"
                                            data-bs-target="#paypal-tab-pane" type="button" role="tab"
                                            aria-controls="paypal-tab-pane" aria-selected="false"
                                            data-payment-method="paypal">PayPal
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link text-dark" id="bank-tab-btn" data-bs-toggle="tab"
                                            data-bs-target="#bank-tab-pane" type="button" role="tab"
                                            aria-controls="bank-tab-pane" aria-selected="false"
                                            data-payment-method="bank_transfer">Bonifico
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="payment-tabs-content">
                                <div class="tab-pane fade show active" id="card-tab-pane" role="tabpanel"
                                     aria-labelledby="card-tab-btn" tabindex="0">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="card-number" class="form-label small fw-semibold">Numero
                                                carta</label>
                                            <input type="text" class="form-control credit-card-input" id="card-number"
                                                   placeholder="1234 5678 9012 3456" maxlength="19"
                                                   autocomplete="cc-number">
                                            <div class="invalid-feedback">Inserisci un numero di carta valido (16
                                                cifre)
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="card-name" class="form-label small fw-semibold">Nome sulla
                                                carta</label>
                                            <input type="text" class="form-control" id="card-name"
                                                   placeholder="Mario Rossi" autocomplete="cc-name">
                                            <div class="invalid-feedback">Inserisci il nome come appare sulla carta
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label for="card-expiry"
                                                   class="form-label small fw-semibold">Scadenza</label>
                                            <input type="text" class="form-control expiry-input" id="card-expiry"
                                                   placeholder="MM/AA" maxlength="5" autocomplete="cc-exp">
                                            <div class="invalid-feedback">Formato: MM/AA</div>
                                        </div>
                                        <div class="col-6">
                                            <label for="card-cvv" class="form-label small fw-semibold">CVV</label>
                                            <input type="text" class="form-control cvv-input" id="card-cvv"
                                                   placeholder="123" maxlength="4" autocomplete="cc-csc">
                                            <div class="invalid-feedback">3-4 cifre sul retro della carta</div>
                                        </div>
                                    </div>

                                    <div class="mt-3 small text-muted">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        Pagamenti Sicuri - I dati non verranno memorizzati
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="paypal-tab-pane" role="tabpanel"
                                     aria-labelledby="paypal-tab-btn" tabindex="0">

                                    <div class="text-center mb-3">
                                        <i class="bi bi-paypal text-primary fs-2"></i>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="paypal-email" class="form-label small fw-semibold">Email
                                                PayPal</label>
                                            <input type="email" class="form-control" id="paypal-email"
                                                   placeholder="la-tua-email@esempio.com">
                                            <div class="invalid-feedback">Inserisci un indirizzo email valido</div>
                                        </div>
                                    </div>

                                    <div class="mt-3 small text-muted">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        Accesso simulato - Nessuna credenziale reale verrà verificata
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="bank-tab-pane" role="tabpanel"
                                     aria-labelledby="bank-tab-btn" tabindex="0">
                                    <div class="p-3 bg-light rounded border">
                                        <p class="fw-medium mb-1 small">Dettagli bancari:</p>
                                        <p class="small mb-0">Intestatario: Artigianato Online S.r.l.</p>
                                        <p class="small mb-0">IBAN: ITXXXXXXXXXXXXXXXXXXXXXXXXX</p>
                                        <p class="small mb-0">Banca: La Banca</p>
                                        <p class="small mt-2">Causale: Ordine <strong id="bank-order-ref">[Numero
                                            Ordine]</strong> - <span id="bank-customer-name">[Nome Cognome]</span></p>
                                    </div>
                                    <p class="small text-muted mt-2">
                                        Il tuo ordine verrà elaborato dopo la ricezione del pagamento (stato:
                                        'pending'). Riceverai i dettagli completi anche via email. Includi il
                                        riferimento ordine e nome/cognome nella causale.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metodo di Spedizione -->
                    <div class="card p-2">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="card-title mb-0 fw-bold">Metodo di spedizione</h5>
                            <small class="text-muted">Scegli come ricevere il tuo ordine</small>
                        </div>
                        <div class="card-body">
                            <div id="shipping-options">
                                <div class="form-check border p-3 rounded d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input" type="radio" name="shippingMethod"
                                               id="shipping-standard" value="standard" data-cost="4.99" checked
                                               required>
                                        <label class="form-check-label ms-2 small" for="shipping-standard">
                                            Spedizione standard (3-5 giorni lavorativi)
                                        </label>
                                    </div>
                                    <div class="fw-medium small">€4.99</div>
                                </div>
                                <div class="form-check border p-3 rounded d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input" type="radio" name="shippingMethod"
                                               id="shipping-express" value="express" data-cost="9.99" required>
                                        <label class="form-check-label ms-2 small" for="shipping-express">
                                            Spedizione espressa (1-2 giorni lavorativi)
                                        </label>
                                    </div>
                                    <div class="fw-medium small">€9.99</div>
                                </div>
                                <div class="form-check border p-3 rounded d-flex justify-content-between align-items-center free-shipping-option"
                                     style="display: none;">
                                    <div>
                                        <input class="form-check-input" type="radio" name="shippingMethod"
                                               id="shipping-free" value="free" data-cost="0.00" required>
                                        <label class="form-check-label ms-2 small" for="shipping-free">
                                            Spedizione gratuita (Ordine > €100)
                                        </label>
                                    </div>
                                    <div class="fw-medium small">Gratuita</div>
                                </div>
                                <div class="invalid-feedback">
                                    Seleziona un metodo di spedizione.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Riepilogo Ordine -->
            <div class="col-lg-4">
                <div class="card sticky-top p-2 shadow-sm" style="top: 20px">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="card-title mb-0 fw-bold">Riepilogo Ordine</h5>
                    </div>
                    <div class="card-body">
                        <div id="cart-summary-items" class="mb-3">
                            <!-- Caricato da JS -->
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                        <hr class="text-dark text-opacity-50">
                        <ul class="list-unstyled mb-3 small">
                            <li class="d-flex justify-content-between">
                                <span>Subtotale</span>
                                <span id="subtotal">€0.00</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span>Spedizione</span>
                                <span id="shipping-cost">€0.00</span>
                            </li>
                        </ul>
                        <hr class="text-dark text-opacity-50">
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-4">
                            <span>Totale</span>
                            <span id="total-price">€0.00</span>
                        </div>
                        <button type="submit" id="complete-order-btn" class="btn btn-dark w-100 fw-semibold py-2">
                            Completa Ordine
                        </button>
                    </div>
                    <div class="card-footer bg-transparent border-top-0 pt-0">
                        <div class="row">
                            <div class="col-12 small text-muted mb-2">
                                <i class="bi bi-shield-check me-1"></i>
                                <span>Pagamento sicuro e crittografato</span>
                            </div>
                            <div class="col-12 small text-muted">
                                <i class="bi bi-truck me-1"></i>
                                <span>Spedizione gratuita per ordini > €100</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


<div id="footer-placeholder"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="js/headerfooterloader.js"></script>
</body>
</html>