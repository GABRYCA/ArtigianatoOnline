<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli Ordine - Artigianato Online</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../images/favicon.png">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link type="text/css" rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        const urlBaseApi = "";
        let datiOrdineGlobali = null;
        let datiOrdineGrezzi = null;
        let datiPagamentoCaricati = false;
        let datiPagamentoGlobali = null;

        $(document).ready(function () {
            const parametriUrl = new URLSearchParams(window.location.search);
            const idOrdine = parametriUrl.get('id');
            const tokenAutenticazione = localStorage.getItem('sessionToken');

            if (!idOrdine) {
                $('.container').html('<div class="alert alert-danger">ID ordine non specificato nell\'URL. Aggiungi ?id=NUMERO_ORDINE</div>').show();
                $('#indicatore-caricamento').hide();
                return;
            }

            if (!tokenAutenticazione) {
                $('.container').html('<div class="alert alert-warning">Accesso non autorizzato. Per favore, <a href="/login.html">effettua il login</a> per visualizzare i tuoi ordini.</div>').show();
                $('#indicatore-caricamento').hide();
                return;
            }
            recuperaDatiOrdine(idOrdine, tokenAutenticazione);

            $('#paymentModal').on('show.bs.modal', function () {
                if (datiOrdineGlobali && datiOrdineGrezzi) {
                    $('#payment-order-id').text(datiOrdineGlobali.id);
                    $('#payment-order-total').text(formattaPrezzo(parseFloat(datiOrdineGrezzi.total_amount)));
                    $('#payment-order-date').text(datiOrdineGlobali.date);
                    $('#payment-bank-order-ref').text(datiOrdineGlobali.id);
                    $('#payment-bank-customer-name').text(datiOrdineGlobali.customer.name);

                    $('#payment-feedback').empty();
                    $('#payment-method-tabs-content .form-control').removeClass('is-valid is-invalid');
                }
            });

            $('#payment-card-number').on('input', function () {
                let valore = $(this).val().replace(/\s/g, '').replace(/[^0-9]/g, '');
                let valoreFormattato = valore.match(/.{1,4}/g)?.join(' ') || valore;
                if (valoreFormattato.length > 19) valoreFormattato = valoreFormattato.substring(0, 19);
                $(this).val(valoreFormattato);

                const numeroSenzaSpazi = valore;
                if (numeroSenzaSpazi.length === 16) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (numeroSenzaSpazi.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#payment-card-expiry').on('input', function () {
                let valore = $(this).val().replace(/[^0-9]/g, '');
                if (valore.length >= 2) {
                    valore = valore.substring(0, 2) + '/' + valore.substring(2, 4);
                }
                $(this).val(valore);

                if (valore.length === 5) {
                    const [mese, anno] = valore.split('/');
                    const meseNum = parseInt(mese, 10);
                    const annoNum = parseInt('20' + anno, 10);
                    const dataCorrente = new Date();
                    const annoCorrente = dataCorrente.getFullYear();
                    const meseCorrente = dataCorrente.getMonth() + 1;

                    if (meseNum >= 1 && meseNum <= 12 && annoNum >= annoCorrente &&
                        !(annoNum === annoCorrente && meseNum < meseCorrente)) {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#payment-card-cvv').on('input', function () {
                let valore = $(this).val().replace(/[^0-9]/g, '');
                if (valore.length > 4) valore = valore.substring(0, 4);
                $(this).val(valore);

                if (valore.length >= 3) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#payment-card-name').on('input', function () {
                const valore = $(this).val().trim();
                if (valore.length >= 3 && valore.includes(' ')) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#payment-paypal-email').on('input', function () {
                const valore = $(this).val().trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(valore)) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (valore.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            $('#payment-method-tabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (event) {
                $('#payment-method-tabs-content .form-control').removeClass('is-valid is-invalid');
                $('#payment-feedback').empty();
            });

            $('#payment-tab').on('shown.bs.tab', function () {
                if (!datiPagamentoCaricati && datiOrdineGrezzi) {
                    caricaDatiPagamento(datiOrdineGrezzi.order_id);
                }
            });
        });

        /**
         * Mostra o nasconde l'indicatore di caricamento
         * @param {boolean} inCaricamento - Se true mostra il caricamento, se false lo nasconde
         */
        function mostraStatoCaricamento(inCaricamento) {
            const contenutoPagina = $('#order-content');
            const indicatoreCaricamento = $('#indicatore-caricamento');
            if (inCaricamento) {
                contenutoPagina.hide();
                indicatoreCaricamento.show();
            } else {
                indicatoreCaricamento.hide();
                contenutoPagina.show();
            }
        }

        /**
         * Gestisce gli errori delle chiamate API
         * @param {Object} rispostaHttp - Oggetto risposta HTTP jQuery
         * @param {string} testoStato - Testo dello stato della richiesta
         * @param {string} errore - Messaggio di errore
         * @param {string} idOrdine - ID dell'ordine per cui si è verificato l'errore
         */
        function gestisciErroreApi(rispostaHttp, testoStato, errore, idOrdine) {
            mostraStatoCaricamento(false);
            console.error("Errore API:", rispostaHttp.status, rispostaHttp.responseText, testoStato, errore);
            let messaggioErrore = `Errore nel caricamento dell'ordine (ID: ${idOrdine}). Si è verificato un problema imprevisto.`;
            if (rispostaHttp.status === 404) {
                messaggioErrore = `Ordine con ID ${idOrdine} non trovato. Verifica l'ID e riprova.`;
            } else if (rispostaHttp.status === 401) {
                messaggioErrore = `Accesso non autorizzato. Effettua il login per visualizzare questo ordine.`;
            } else if (rispostaHttp.status === 403) {
                messaggioErrore = `Non hai i permessi necessari per visualizzare l'ordine ${idOrdine}.`;
            } else if (rispostaHttp.status >= 500) {
                messaggioErrore = `Errore del server durante il caricamento dell'ordine ${idOrdine}. Riprova più tardi o contatta l'assistenza.`;
            }
            $('.container').html(`<div class="alert alert-danger">${messaggioErrore}</div>`);
        }

        /**
         * Recupera i dati dell'ordine tramite API
         * @param {string} idOrdine - ID dell'ordine da recuperare
         * @param {string} token - Token di autenticazione
         */        function recuperaDatiOrdine(idOrdine, token) {
            mostraStatoCaricamento(true);
            resetDatiPagamento();

            $.ajax({
                url: `${urlBaseApi}/api/orders/${idOrdine}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function (datiGrezzi) {
                    if (!datiGrezzi) {
                        mostraStatoCaricamento(false);
                        $('.container').html(`<div class="alert alert-warning">Risposta API non valida o vuota per l'ordine ${idOrdine}.</div>`);
                        return;
                    }
                    try {
                        datiOrdineGrezzi = datiGrezzi;
                        const datiOrdineElaborati = mappaDatiOrdine(datiGrezzi);
                        datiOrdineGlobali = datiOrdineElaborati;
                        popolaPagina(datiOrdineElaborati);
                        mostraStatoCaricamento(false);
                    } catch (erroreElaborazione) {
                        mostraStatoCaricamento(false);
                        console.error("Errore durante la mappatura o popolamento:", erroreElaborazione);
                        $('.container').html(`<div class="alert alert-danger">Errore nell'elaborazione dei dati dell'ordine.</div>`);
                    }
                },
                error: function (rispostaHttp, testoStato, errore) {
                    gestisciErroreApi(rispostaHttp, testoStato, errore, idOrdine);
                }
            });
        }

        /**
         * Carica i dati di pagamento per l'ordine specificato
         * @param {number} idOrdine - ID dell'ordine per cui recuperare i dati di pagamento
         */
        function caricaDatiPagamento(idOrdine) {
            const tokenAutenticazione = localStorage.getItem('sessionToken');

            $('#payment-method').text('Caricamento...');
            $('#payment-status').text('Caricamento...');
            $('#payment-total').text('Caricamento...');

            $.ajax({
                url: `${urlBaseApi}/api/payments/order/${idOrdine}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${tokenAutenticazione}`
                },
                success: function (datiPagamento) {
                    datiPagamentoGlobali = datiPagamento;
                    datiPagamentoCaricati = true;
                    aggiornaPagamentoDati(datiPagamento);
                }, error: function (rispostaHttp, testoStato, errore) {
                    if (rispostaHttp.status === 404) {
                        console.info('Nessun pagamento registrato per questo ordine');
                        if (datiOrdineGrezzi && datiOrdineGrezzi.status === 'pending') {
                            $('#payment-method').text('In attesa');
                            $('#payment-status').text('In attesa di pagamento').removeClass().addClass('text-warning');
                            $('#payment-total').text('€ 0.00');
                        } else {
                            aggiornaPagamentoDati(null);
                        }
                    } else {
                        console.error('Errore nel caricamento dei dati di pagamento:', errore);
                        $('#payment-method').text('Errore di caricamento');
                        $('#payment-status').text('Errore').removeClass().addClass('text-danger');
                        $('#payment-total').text('N/D');
                    }
                    datiPagamentoCaricati = true;
                }
            });
        }

        /**
         * Aggiorna l'interfaccia della tab pagamento con i dati ricevuti
         * @param {Object|null} datiPagamento - Dati del pagamento o null se non disponibili
         */
        function aggiornaPagamentoDati(datiPagamento) {
            if (datiPagamento) {
                const mappaMetodiPagamento = {
                    'credit_card': 'Carta di Credito',
                    'paypal': 'PayPal',
                    'bank_transfer': 'Bonifico Bancario',
                    'other': 'Altro'
                };

                const mappaStatiPagamento = {
                    'pending': {text: 'In Attesa', color: 'warning'},
                    'completed': {text: 'Completato', color: 'success'},
                    'failed': {text: 'Fallito', color: 'danger'},
                    'refunded': {text: 'Rimborsato', color: 'info'}
                };

                const metodoPagamento = mappaMetodiPagamento[datiPagamento.payment_method] || datiPagamento.payment_method || 'N/D';
                const infoStato = mappaStatiPagamento[datiPagamento.status] || {
                    text: datiPagamento.status || 'N/D',
                    color: 'muted'
                };

                $('#payment-method').text(metodoPagamento);
                $('#payment-status').text(infoStato.text).removeClass().addClass(`text-${infoStato.color}`);
                $('#payment-total').text(formattaPrezzo(parseFloat(datiPagamento.amount)));

                if (datiPagamento.transaction_id) {
                    $('.payment-transaction-info').remove();

                    const infoTransazione = $(`
                        <div class="payment-transaction-info d-flex justify-content-between small mt-2 pt-2 border-top">
                            <span class="text-muted">ID Transazione</span>
                            <span class="font-monospace small">${datiPagamento.transaction_id}</span>
                        </div>
                    `);
                    $('#payment-total').parent().after(infoTransazione);
                }

                if (datiPagamento.payment_date) {
                    $('.payment-date-info').remove();

                    const dataFormattata = formattaData(datiPagamento.payment_date, true);
                    const infoData = $(`
                        <div class="payment-date-info d-flex justify-content-between small mt-1">
                            <span class="text-muted">Data Pagamento</span>
                            <span>${dataFormattata}</span>
                        </div>
                    `);

                    const ultimoElemento = $('.payment-transaction-info').length > 0 ?
                        $('.payment-transaction-info') :
                        $('#payment-total').parent();
                    ultimoElemento.before(infoData);
                }

            } else {
                $('#payment-method').text('N/D');
                $('#payment-status').text('N/D').removeClass().addClass('text-muted');
                $('#payment-total').text('€ 0.00');

                $('.payment-transaction-info, .payment-date-info').remove();
            }
        }

        /**
         * Mappa i dati grezzi dell'ordine in un formato strutturato per la visualizzazione
         * @param {Object} datiGrezzi - Dati grezzi ricevuti dall'API
         * @returns {Object} Dati dell'ordine mappati e formattati
         */
        function mappaDatiOrdine(datiGrezzi) {
            const mappaStati = {
                pending: {text: "In Attesa di Pagamento", progress: 10, icon: 'bi-hourglass-split', color: 'warning'},
                paid: {text: "Pagato", progress: 20, icon: 'bi-credit-card', color: 'info'},
                processing: {text: "In Lavorazione", progress: 40, icon: 'bi-gear', color: 'info'},
                preparing: {text: "In Preparazione", progress: 60, icon: 'bi-box-seam', color: 'primary'},
                shipped: {text: "Spedito", progress: 80, icon: 'bi-truck', color: 'warning'},
                delivered: {text: "Consegnato", progress: 100, icon: 'bi-check-circle-fill', color: 'success'},
                cancelled: {text: "Annullato", progress: 0, icon: 'bi-x-circle-fill', color: 'danger'},
                refunded: {text: "Rimborsato", progress: 0, icon: 'bi-arrow-counterclockwise', color: 'secondary'},
                default: {text: datiGrezzi.status, progress: 50, icon: 'bi-question-circle', color: 'secondary'}
            };
            const infoStatoCorrente = mappaStati[datiGrezzi.status] || mappaStati.default;

            return {
                id: datiGrezzi.order_id,
                date: formattaData(datiGrezzi.order_date),
                status: infoStatoCorrente.text,
                statusColor: infoStatoCorrente.color,
                statusIcon: infoStatoCorrente.icon, progress: infoStatoCorrente.progress,
                rawStatus: datiGrezzi.status,
                lastUpdate: formattaData(datiGrezzi.updated_at, true),
                items: datiGrezzi.items.map(articolo => ({
                    id: articolo.product_id,
                    name: articolo.product_name,
                    price: articolo.price_per_unit,
                    quantity: articolo.quantity,
                    image: articolo.product_image_url || '../images/favicon.png',
                    artisan: articolo.artisan_shop_name || `Artigiano ID: ${articolo.artisan_id}`,
                    sku: articolo.product_sku || 'N/D'
                })),
                shipping: {
                    method: traduciMetodoSpedizione(datiGrezzi.shipping_method),
                    address: datiGrezzi.shipping_address ? datiGrezzi.shipping_address.split(',').map(p => p.trim()) : ['Indirizzo non fornito'],
                    trackingNumber: datiGrezzi.tracking_number || 'Non disponibile',
                }, billing: {
                    address: datiGrezzi.billing_address ? datiGrezzi.billing_address.split(',').map(p => p.trim()) : (datiGrezzi.shipping_address ? datiGrezzi.shipping_address.split(',').map(p => p.trim()) : ['Indirizzo non fornito']),
                },
                customer: {
                    name: datiGrezzi.customer_full_name || `Cliente ID: ${datiGrezzi.customer_id}`,
                    email: datiGrezzi.customer_email || 'Email non disponibile'
                }
            };
        }

        /**
         * Popola la pagina con i dati dell'ordine
         * @param {Object} datiOrdine - Oggetto contenente tutti i dati dell'ordine formattati
         */
        function popolaPagina(datiOrdine) {
            $('#order-id-title').text(datiOrdine.id);
            $('#order-date-header').text(datiOrdine.date);

            const badgeStato = $('#order-status-badge');
            badgeStato.text(datiOrdine.status).removeClass().addClass(`badge fs-6 bg-${datiOrdine.statusColor}`);
            $('#order-progress-bar').css('width', datiOrdine.progress + '%').removeClass().addClass(`progress-bar bg-${datiOrdine.statusColor}`);
            const iconaStato = $('#status-icon-current');
            iconaStato.removeClass().addClass(`status-icon border-${datiOrdine.statusColor} text-${datiOrdine.statusColor}`);
            if (datiOrdine.progress === 100 || datiOrdine.status === 'Annullato' || datiOrdine.status === 'Rimborsato') {
                iconaStato.removeClass(`text-${datiOrdine.statusColor}`).addClass(`bg-${datiOrdine.statusColor} text-white completed`);
                $('#status-icon-current i').removeClass().addClass(`bi ${datiOrdine.statusIcon}`);
            } else {
                $('#status-icon-current i').removeClass().addClass(`bi ${datiOrdine.statusIcon}`);
            }
            $('#status-text-current').text(datiOrdine.status);
            $('#status-date-current').text(datiOrdine.lastUpdate);


            const contenitoreArticoli = $('#order-items-container');
            contenitoreArticoli.empty();
            if (datiOrdine.items && datiOrdine.items.length > 0) {
                datiOrdine.items.forEach(articolo => {
                    const htmlArticolo = `
                    <div class="d-flex gap-3 align-items-start">
                         <img src="${articolo.image}" alt="${articolo.name}" class="rounded immagine-prodotto-ordini" onerror="this.onerror=null; this.src='../images/placeholder-image.png';">
                        <div class="flex-grow-1 my-auto">
                            <a href="../prodotto.html?id=${articolo.id}" class="fw-bold text-decoration-none link-dark">${articolo.name}</a>
                            <p class="text-muted small mb-1">Artigiano: ${articolo.artisan}</p>
                            <p class="text-muted small mb-1">SKU: ${articolo.sku}</p>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <span class="small">Quantità: ${articolo.quantity}</span>
                                <span class="fw-bold">€ ${articolo.price}</span>
                            </div>
                        </div>
                    </div>
                    ${datiOrdine.items.indexOf(articolo) < datiOrdine.items.length - 1 ? '<hr class="my-3">' : ''}
                `;
                    contenitoreArticoli.append(htmlArticolo);
                });
            } else {
                contenitoreArticoli.html('<p class="text-muted">Nessun prodotto trovato per questo ordine.</p>');
            }

            $('#shipping-method').text(datiOrdine.shipping.method);
            const indirizzoSpedizione = $('#shipping-address');
            indirizzoSpedizione.empty();
            datiOrdine.shipping.address.forEach(riga => indirizzoSpedizione.append(`<p class="mb-0">${riga}</p>`));
            $('#tracking-info').find('#tracking-number').text(datiOrdine.shipping.trackingNumber || 'N/D');


            const indirizzoFatturazione = $('#billing-address');
            indirizzoFatturazione.empty();
            datiOrdine.billing.address.forEach(riga => indirizzoFatturazione.append(`<p class="mb-0">${riga}</p>`));
            $('#billing-order-date').text(datiOrdine.date);
            $('#billing-order-id').text(datiOrdine.id);

            $('#summary-order-id').text(datiOrdine.id);
            $('#summary-date').text(datiOrdine.date);
            const badgeStatoRiepilogo = $('#summary-status-badge');
            badgeStatoRiepilogo.text(datiOrdine.status).removeClass().addClass(`badge bg-${datiOrdine.statusColor}`);

            $('#summary-customer-name').text(datiOrdine.customer.name);
            $('#summary-customer-email').text(datiOrdine.customer.email);
            $('#summary-total').text(formattaPrezzo(parseFloat(datiOrdineGrezzi.total_amount)));

            gestisciPulsantePagaNora(datiOrdine);
        }

        /**
         * Traduce il metodo di spedizione dall'inglese all'italiano
         * @param {string} metodo - Il metodo di spedizione in inglese
         * @returns {string} Il metodo tradotto in italiano
         */
        function traduciMetodoSpedizione(metodo) {
            const traduzioni = {
                'standard': 'Spedizione standard',
                'express': 'Spedizione espressa',
                'free': 'Spedizione gratuita',
                'Spedizione standard': 'Spedizione standard',
                'Spedizione espressa': 'Spedizione espressa',
                'Spedizione gratuita': 'Spedizione gratuita'
            };
            return traduzioni[metodo] || metodo || 'N/D';
        }

        /**
         * Gestisce la visualizzazione del pulsante "Paga ora" per ordini in attesa di pagamento
         * @param {Object} datiOrdine - Dati dell'ordine
         */        function gestisciPulsantePagaNora(datiOrdine) {
            const contenitoreAzioni = $('.card-body.d-grid.gap-2');

            contenitoreAzioni.find('#pay-now-btn').remove();

            if (datiOrdine.rawStatus === 'pending') {
                const pulsantePagaNora = $(`
                    <button type="button" id="pay-now-btn" class="btn btn-warning text-start py-2" data-bs-toggle="modal" data-bs-target="#paymentModal">
                        <i class="bi bi-credit-card me-2"></i>Paga ora                    </button>
                `);

                contenitoreAzioni.prepend(pulsantePagaNora);
            }
        }

        /**
         * Formatta un prezzo in formato euro
         * @param {number} prezzo - Il prezzo da formattare
         * @returns {string} Il prezzo formattato (es. "€12.50")
         */
        function formattaPrezzo(prezzo) {
            if (typeof prezzo !== 'number' || isNaN(prezzo)) {
                console.warn("Tentativo di formattare un prezzo non valido:", prezzo);
                return '€--.--';
            }
            return `€${prezzo.toFixed(2)}`;
        }

        /**
         * Mostra un alert Bootstrap
         * @param {string} messaggio - Il messaggio da mostrare
         * @param {string} tipo - Il tipo di alert (success, danger, warning, info)
         * @param {string} contenitore - ID del contenitore dove mostrare l'alert
         */
        function mostraAlert(messaggio, tipo, contenitore = 'payment-feedback') {
            const classeAlert = `alert alert-${tipo} alert-dismissible fade show`;
            const htmlAlert = `
                <div class="${classeAlert}" role="alert">
                    ${messaggio}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            $(`#${contenitore}`).html(htmlAlert);
        }

        /**
         * Valida i dati di pagamento in base al metodo selezionato
         * @param {string} metodoPagamento - Il metodo di pagamento selezionato
         * @returns {boolean} - True se la validazione è passata
         */
        function validaDatiPagamento(metodoPagamento) {
            let valido = true;

            if (metodoPagamento === 'credit_card') {
                const numeroCartaElement = $('#payment-card-number');
                const nomeCartaElement = $('#payment-card-name');
                const scadenzaElement = $('#payment-card-expiry');
                const cvvElement = $('#payment-card-cvv');

                const numeroCarta = numeroCartaElement.val().replace(/\s/g, '');
                const nomeCarta = nomeCartaElement.val().trim();
                const scadenza = scadenzaElement.val();
                const cvv = cvvElement.val();

                if (numeroCarta.length !== 16 || !/^\d{16}$/.test(numeroCarta)) {
                    numeroCartaElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    numeroCartaElement.addClass('is-valid').removeClass('is-invalid');
                }

                if (nomeCarta.length < 3 || !nomeCarta.includes(' ')) {
                    nomeCartaElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    nomeCartaElement.addClass('is-valid').removeClass('is-invalid');
                }

                const [mese, anno] = scadenza.split('/');
                const meseNum = parseInt(mese, 10);
                const annoNum = parseInt('20' + anno, 10);
                const dataCorrente = new Date();
                const annoCorrente = dataCorrente.getFullYear();
                const meseCorrente = dataCorrente.getMonth() + 1;

                if (scadenza.length === 5 && mese && anno &&
                    meseNum >= 1 && meseNum <= 12 && annoNum >= annoCorrente &&
                    !(annoNum === annoCorrente && meseNum < meseCorrente)) {
                    scadenzaElement.removeClass('is-invalid').addClass('is-valid');
                } else {
                    scadenzaElement.removeClass('is-valid').addClass('is-invalid');
                    valido = false;
                }

                if (cvv.length >= 3 && cvv.length <= 4 && /^\d{3,4}$/.test(cvv)) {
                    cvvElement.removeClass('is-invalid').addClass('is-valid');
                } else {
                    cvvElement.removeClass('is-valid').addClass('is-invalid');
                    valido = false;
                }
            } else if (metodoPagamento === 'paypal') {
                const emailElement = $('#payment-paypal-email');
                const email = emailElement.val().trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (!emailRegex.test(email)) {
                    emailElement.addClass('is-invalid').removeClass('is-valid');
                    valido = false;
                } else {
                    emailElement.addClass('is-valid').removeClass('is-invalid');
                }
            }

            return valido;
        }

        /**
         * Simula l'elaborazione del pagamento e genera un transaction_id
         * @param {string} metodoPagamento - Il metodo di pagamento
         * @param {number} importo - L'importo del pagamento
         * @returns {Promise} - Promise che risolve con i dati del pagamento simulato
         */
        async function simulaElaborazionePagamento(metodoPagamento, importo) {
            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));

            const successo = Math.random() > 0.05;

            if (!successo) {
                const errori = [
                    'Carta di credito rifiutata',
                    'Fondi insufficienti',
                    'Carta scaduta',
                    'Credenziali PayPal non valide',
                    'Servizio temporaneamente non disponibile'
                ];
                const erroreSimulato = errori[Math.floor(Math.random() * errori.length)];
                throw new Error(erroreSimulato);
            }

            let transactionId;
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 10).toUpperCase();

            switch (metodoPagamento) {
                case 'credit_card':
                    transactionId = `CC_${timestamp}_${random}`;
                    break;
                case 'paypal':
                    transactionId = `PAYPAL_${timestamp}_${random}`;
                    break;
                case 'bank_transfer':
                    transactionId = `BANK_${timestamp}_${random}`;
                    break;
                default:
                    transactionId = `TXN_${timestamp}_${random}`;
            }

            return {
                transactionId: transactionId,
                status: 'completed',
                paymentDate: new Date().toISOString(),
                amount: importo,
                method: metodoPagamento
            };
        }

        /**
         * Gestisce il processo di pagamento
         */
        async function elaboraPagamento() {
            if (!datiOrdineGlobali || !datiOrdineGrezzi) {
                mostraAlert('Errore: dati ordine non disponibili per il pagamento.', 'danger');
                return;
            }

            const metodoPagamento = $('#payment-method-tabs .nav-link.active').data('payment-method') || 'credit_card';
            const pulsantePaga = $('#process-payment-btn');
            const spinner = pulsantePaga.find('.spinner-border');

            if (metodoPagamento !== 'bank_transfer' && !validaDatiPagamento(metodoPagamento)) {
                const messaggioMetodo = metodoPagamento === 'credit_card' ? 'carta di credito' : 'PayPal';
                mostraAlert(`Per favore, inserisci tutti i dati richiesti per il pagamento con ${messaggioMetodo}.`, 'warning');
                return;
            }

            pulsantePaga.prop('disabled', true);
            spinner.removeClass('d-none');
            pulsantePaga.find('.btn-text').text('Elaborazione...');

            try {
                const importoTotale = parseFloat(datiOrdineGrezzi.total_amount);
                let resultSimulazione = null;

                if (metodoPagamento !== 'bank_transfer') {
                    try {
                        console.log(`Elaborazione pagamento ${metodoPagamento} per importo €${importoTotale}...`);
                        resultSimulazione = await simulaElaborazionePagamento(metodoPagamento, importoTotale);
                        console.log('Pagamento simulato completato:', resultSimulazione);
                    } catch (errorePagamento) {
                        console.error("Errore pagamento:", errorePagamento);
                        mostraAlert(`Pagamento non riuscito: ${errorePagamento.message}. Riprova con un altro metodo di pagamento.`, 'danger');
                        pulsantePaga.prop('disabled', false);
                        spinner.addClass('d-none');
                        pulsantePaga.find('.btn-text').text('Completa Pagamento');
                        return;
                    }
                }

                const datiPagamento = {
                    order_id: datiOrdineGrezzi.order_id,
                    amount: importoTotale,
                    payment_method: metodoPagamento,
                    status: (metodoPagamento === 'bank_transfer') ? 'pending' : 'completed',
                    payment_date: new Date().toISOString(), ...(resultSimulazione?.transactionId && {transaction_id: resultSimulazione.transactionId})
                };

                console.log("Invio Payload Pagamento:", JSON.stringify(datiPagamento, null, 2));
                const rispostaPagamento = await fetch(`${urlBaseApi}/api/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('sessionToken')}`
                    },
                    body: JSON.stringify(datiPagamento)
                });

                if (!rispostaPagamento.ok) {
                    let messaggioErrore = `Errore ${rispostaPagamento.status}: ${rispostaPagamento.statusText}`;
                    try {
                        const datiErrore = await rispostaPagamento.json();
                        messaggioErrore = `Errore registrazione pagamento: ${datiErrore.message || messaggioErrore}`;
                    } catch (e) {

                    }
                    throw new Error(messaggioErrore);
                }
                const esitoPagamento = await rispostaPagamento.json();
                console.log("Risposta Pagamento:", esitoPagamento);

                const messaggioSuccesso = metodoPagamento === 'bank_transfer'
                    ? `Pagamento registrato! L'ordine #${datiOrdineGrezzi.order_id} verrà elaborato dopo la ricezione del bonifico bancario.`
                    : `Pagamento completato con successo! L'ordine #${datiOrdineGrezzi.order_id} è stato pagato.`;

                mostraAlert(messaggioSuccesso, 'success');

                setTimeout(() => {
                    $('#paymentModal').modal('hide');
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error("Errore durante il pagamento:", error);
                mostraAlert(`Errore durante il pagamento: ${error.message}. Riprova o contatta l'assistenza.`, 'danger');
            } finally {
                pulsantePaga.prop('disabled', false);
                spinner.addClass('d-none');
                pulsantePaga.find('.btn-text').text('Completa Pagamento');
            }
        }

        /**
         * Formatta una stringa di data nel formato locale italiano
         * @param {string} stringaData - Stringa della data da formattare
         * @param {boolean} includiOreEMinuti - Se includere ore e minuti nella formattazione
         * @returns {string} Data formattata in italiano o il valore originale in caso di errore
         */
        function formattaData(stringaData, includiOreEMinuti = false) {
            if (!stringaData) return 'N/D';
            try {
                const dataOggetto = new Date(stringaData);
                if (isNaN(dataOggetto.getTime())) {
                    throw new Error("Data non valida");
                }

                const opzioniFormattazione = {
                    year: 'numeric', month: 'long', day: 'numeric'
                };
                if (includiOreEMinuti) {
                    opzioniFormattazione.hour = '2-digit';
                    opzioniFormattazione.minute = '2-digit';
                }
                return dataOggetto.toLocaleDateString('it-IT', opzioniFormattazione);
            } catch (erroreFormattazione) {
                console.error("Errore formattazione data:", stringaData, erroreFormattazione);
                return stringaData;
            }
        }

        /**
         * Resetta lo stato dei dati di pagamento quando si carica un nuovo ordine
         */
        function resetDatiPagamento() {
            datiPagamentoCaricati = false;
            datiPagamentoGlobali = null;

            $('#payment-method').text('N/D');
            $('#payment-status').text('N/D').removeClass().addClass('text-muted');
            $('#payment-total').text('€ 0.00');

            $('.payment-transaction-info, .payment-date-info').remove();
        }
    </script>
</head>
<body>

<!-- Indicatore di caricamento -->
<div id="indicatore-caricamento" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="mt-2">Caricamento dettagli ordine...</p>
</div>

<div class="container py-5" id="order-content" style="display: none;">
    <div class="row mb-3">
        <div class="col">
            <a href="../account.html" class="link-dark text-decoration-none"><p class="small"><i
                    class="bi bi-arrow-left"></i> Torna ai tuoi ordini</p></a>
        </div>
    </div>

    <div class="row justify-content-between align-items-start mb-4">
        <div class="col-auto">
            <h1 class="h3 fw-bold">Ordine <span id="order-id-title">...</span></h1>
            <p class="text-muted mb-0">Effettuato il <span id="order-date-header">...</span></p>
        </div>
        <div class="col-auto mt-3 mt-md-0 d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" disabled>
                <i class="bi bi-download"></i>
                <span>Fattura</span>
            </button>
            <a href="mailto:supporto@artigianato.it"
               class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
                <i class="bi bi-headset"></i>
                <span>Assistenza</span>
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Colonna Principale -->
        <div class="col-lg-8">
            <div class="d-flex flex-column gap-4">
                <div class="card p-2">
                    <div class="card-header bg-white border-bottom-0 pb-2">
                        <h5 class="card-title d-flex mb-0 fw-bold">
                            <i class="bi bi-box-seam me-2"></i>
                            Stato dell'ordine
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge fs-6" id="order-status-badge">Caricamento...</span>
                        </div>
                        <div class="progress" role="progressbar" aria-label="Stato ordine" aria-valuenow="50"
                             aria-valuemin="0" aria-valuemax="100" style="height: 8px">
                            <div class="progress-bar" id="order-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="mt-4">
                            <div class="d-flex align-items-start gap-3">
                                <div class="icona-stato" id="status-icon-current">
                                    <i class="bi"></i>
                                </div>
                                <div>
                                    <p class="fw-bold mb-1" id="status-text-current">...</p>
                                    <p class="text-muted small mb-0">Aggiornato il: <span
                                            id="status-date-current">...</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prodotti -->
                <div class="card">
                    <div class="card-header bg-white border-bottom-0 p-3">
                        <h5 class="card-title mb-1 fw-bold">Prodotti</h5>
                        <p class="card-subtitle text-muted small">Prodotti inclusi nel tuo ordine</p>
                    </div>
                    <div class="card-body">
                        <div id="order-items-container" class="d-flex flex-column gap-4">
                            <div class="text-center text-muted">Caricamento prodotti...</div>
                        </div>
                    </div>
                </div>

                <!-- Informazioni -->
                <div class="card p-2">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="card-title mb-0 fw-bold">Informazioni aggiuntive</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="infoTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark active" id="shipping-tab" data-bs-toggle="tab"
                                        data-bs-target="#shipping-tab-pane" type="button" role="tab"
                                        aria-controls="shipping-tab-pane" aria-selected="true">Spedizione
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark" id="billing-tab" data-bs-toggle="tab"
                                        data-bs-target="#billing-tab-pane" type="button" role="tab"
                                        aria-controls="billing-tab-pane" aria-selected="false">Fatturazione
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark" id="payment-tab" data-bs-toggle="tab"
                                        data-bs-target="#payment-tab-pane" type="button" role="tab"
                                        aria-controls="payment-tab-pane" aria-selected="false">Pagamento
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content pt-4" id="infoTabContent">
                            <div class="tab-pane fade show active" id="shipping-tab-pane" role="tabpanel"
                                 aria-labelledby="shipping-tab" tabindex="0">
                                <div class="d-flex align-items-center gap-2 text-muted mb-3">
                                    <i class="bi bi-truck"></i>
                                    <span id="shipping-method">...</span>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-2">Indirizzo di spedizione</h6>
                                        <div class="text-muted small" id="shipping-address">
                                            <p class="mb-0">Caricamento...</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-2">Informazioni di tracking</h6>
                                        <div class="text-muted small" id="tracking-info">
                                            <p class="mb-1">Codice tracking: <span
                                                    id="tracking-number">N/D</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="billing-tab-pane" role="tabpanel"
                                 aria-labelledby="billing-tab" tabindex="0">
                                <h6 class="fw-bold mb-2">Indirizzo di fatturazione</h6>
                                <div class="text-muted small" id="billing-address">
                                    <p class="mb-0">Caricamento...</p>
                                </div>
                                <hr>
                                <div class="d-flex align-items-center gap-2 text-muted small mb-2">
                                    <i class="bi bi-calendar-event"></i>
                                    <span>Data Ordine: <span id="billing-order-date">...</span></span>
                                </div>
                                <div class="d-flex align-items-center gap-2 text-muted small">
                                    <i class="bi bi-hash"></i>
                                    <span>ID Ordine: <span id="billing-order-id">...</span></span>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="payment-tab-pane" role="tabpanel"
                                 aria-labelledby="payment-tab" tabindex="0">
                                <div class="d-flex align-items-center gap-2 text-muted mb-3">
                                    <i class="bi bi-credit-card"></i>
                                    <span>Dettagli Pagamento</span>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex justify-content-between small">
                                        <span class="text-muted">Metodo Pagamento</span>
                                        <span id="payment-method">Non disponibile</span>
                                    </div>
                                    <div class="d-flex justify-content-between small">
                                        <span class="text-muted">Stato Pagamento</span>
                                        <span id="payment-status">Non disponibile</span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold border-top pt-2 mt-2">
                                        <span>Totale Pagato</span>
                                        <span id="payment-total">€ 0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Colonna Laterale -->
        <div class="col-lg-4">
            <div class="d-flex flex-column gap-4">
                <div class="card p-2">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="card-title mb-0 fw-bold">Riepilogo</h5>
                    </div>
                    <div class="card-body pb-1 d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Numero ordine</span>
                            <span class="fw-bold" id="summary-order-id">...</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Data</span>
                            <span class="fw-bold" id="summary-date">...</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Stato</span>
                            <span class="badge" id="summary-status-badge">...</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Cliente</span>
                            <span id="summary-customer-name" class="text-end">...</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Email</span>
                            <span id="summary-customer-email" class="text-end">...</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Totale</span>
                            <span id="summary-total">€ 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Azioni -->
                <div class="card p-2">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="card-title mb-0 fw-bold">Azioni</h5>
                    </div>                    <div class="card-body d-grid gap-2"><a href="mailto:supporto@artigianato.it"
                                                           class="btn btn-outline-secondary text-start">
                        <i class="bi bi-headset me-2"></i>Contatta l'assistenza
                    </a>
                        <button type="button" class="btn btn-outline-secondary text-start py-2" disabled>
                            <i class="bi bi-download me-2"></i>Scarica fattura
                        </button>
                    </div>
                </div>

                <!-- Assistenza -->
                <div class="card p-2">
                    <div class="card-header bg-white border-bottom-0">
                        <h5 class="card-title mb-0 fw-bold">Hai bisogno di aiuto?</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Se hai domande o problemi con il tuo ordine, il nostro team di
                            assistenza è a tua disposizione.</p>
                        <a href="mailto:supporto@artigianato.it" class="btn btn-dark w-100 mt-2 py-2 pt-1">Contatta
                            l'assistenza</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale Pagamento -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-credit-card me-2"></i>Completa il Pagamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="payment-feedback" class="mb-3"></div>

                <!-- Riepilogo Ordine -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 fw-bold">Riepilogo Ordine</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Ordine #<span id="payment-order-id">-</span></span>
                            <span class="fw-bold" id="payment-order-total">€ 0.00</span>
                        </div>
                        <div class="small text-muted">
                            Effettuato il <span id="payment-order-date">-</span>
                        </div>
                    </div>
                </div>

                <!-- Metodi di Pagamento -->
                <div class="card">
                    <div class="card-header bg-white border-bottom-0">
                        <h6 class="mb-0 fw-bold">Scegli il metodo di pagamento</h6>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-fill mb-3" id="payment-method-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark active" id="payment-card-tab-btn" data-bs-toggle="tab"
                                        data-bs-target="#payment-card-tab-pane" type="button" role="tab"
                                        aria-controls="payment-card-tab-pane" aria-selected="true"
                                        data-payment-method="credit_card">Carta di credito
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark" id="payment-paypal-tab-btn" data-bs-toggle="tab"
                                        data-bs-target="#payment-paypal-tab-pane" type="button" role="tab"
                                        aria-controls="payment-paypal-tab-pane" aria-selected="false"
                                        data-payment-method="paypal">PayPal
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark" id="payment-bank-tab-btn" data-bs-toggle="tab"
                                        data-bs-target="#payment-bank-tab-pane" type="button" role="tab"
                                        aria-controls="payment-bank-tab-pane" aria-selected="false"
                                        data-payment-method="bank_transfer">Bonifico
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="payment-method-tabs-content">
                            <!-- Carta di Credito -->
                            <div class="tab-pane fade show active" id="payment-card-tab-pane" role="tabpanel"
                                 aria-labelledby="payment-card-tab-btn" tabindex="0">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="payment-card-number" class="form-label small fw-semibold">Numero
                                            carta</label>
                                        <input type="text" class="form-control" id="payment-card-number"
                                               placeholder="1234 5678 9012 3456" maxlength="19">
                                        <div class="invalid-feedback">Inserisci un numero di carta valido (16 cifre)
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="payment-card-name" class="form-label small fw-semibold">Nome sulla
                                            carta</label>
                                        <input type="text" class="form-control" id="payment-card-name"
                                               placeholder="Mario Rossi">
                                        <div class="invalid-feedback">Inserisci il nome come appare sulla carta</div>
                                    </div>
                                    <div class="col-6">
                                        <label for="payment-card-expiry"
                                               class="form-label small fw-semibold">Scadenza</label>
                                        <input type="text" class="form-control" id="payment-card-expiry"
                                               placeholder="MM/AA" maxlength="5">
                                        <div class="invalid-feedback">Formato: MM/AA</div>
                                    </div>
                                    <div class="col-6">
                                        <label for="payment-card-cvv" class="form-label small fw-semibold">CVV</label>
                                        <input type="text" class="form-control" id="payment-card-cvv"
                                               placeholder="123" maxlength="4">
                                        <div class="invalid-feedback">3-4 cifre sul retro della carta</div>
                                    </div>
                                </div>
                                <div class="mt-3 small text-muted">
                                    <i class="bi bi-shield-lock me-1"></i>
                                    Pagamenti Sicuri - I dati non verranno memorizzati
                                </div>
                            </div>

                            <!-- PayPal -->
                            <div class="tab-pane fade" id="payment-paypal-tab-pane" role="tabpanel"
                                 aria-labelledby="payment-paypal-tab-btn" tabindex="0">
                                <div class="text-center mb-3">
                                    <i class="bi bi-paypal text-primary fs-2"></i>
                                </div>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="payment-paypal-email" class="form-label small fw-semibold">Email
                                            PayPal</label>
                                        <input type="email" class="form-control" id="payment-paypal-email"
                                               placeholder="la-tua-email@esempio.com">
                                        <div class="invalid-feedback">Inserisci un indirizzo email valido</div>
                                    </div>
                                </div>
                                <div class="mt-3 small text-muted">
                                    <i class="bi bi-shield-lock me-1"></i>
                                    Accesso simulato - Nessuna credenziale reale verrà verificata
                                </div>
                            </div>

                            <!-- Bonifico Bancario -->
                            <div class="tab-pane fade" id="payment-bank-tab-pane" role="tabpanel"
                                 aria-labelledby="payment-bank-tab-btn" tabindex="0">
                                <div class="p-3 bg-light rounded border">
                                    <p class="fw-medium mb-1 small">Dettagli bancari:</p>
                                    <div class="small">
                                        <p class="small mb-0">Intestatario: Artigianato Online S.r.l.</p>
                                        <p class="small mb-0">IBAN: ITXXXXXXXXXXXXXXXXXXXXXXXXX</p>
                                        <p class="small mb-0">Banca: La Banca</p>
                                        <p class="small mt-2">Causale: Ordine <strong id="payment-bank-order-ref">[Numero
                                            Ordine]</strong> - <span
                                                id="payment-bank-customer-name">[Nome Cognome]</span></p>
                                    </div>
                                </div>
                                <p class="small text-muted mt-2">
                                    Il tuo ordine verrà elaborato dopo la ricezione del pagamento.
                                    Riceverai i dettagli completi anche via email.
                                    Includi il riferimento ordine e nome/cognome nella causale.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-warning" id="process-payment-btn" onclick="elaboraPagamento()">
                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                    <span class="btn-text">Completa Pagamento</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
        crossorigin="anonymous"></script>
</body>
</html>